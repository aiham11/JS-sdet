// For subfolders, check and create under the last folder
QueryRequest subFolderExistenceRequest = new QueryRequest("testfolder");
subFolderExistenceRequest.setQueryFilter(new QueryFilter("Name", "=", folderName.trim())
        .and(new QueryFilter("Parent", "=", lastFolderRef))
        .and(new QueryFilter("Project", "=", "project/" + projectRef)));
subFolderExistenceRequest.setFetch(new Fetch("_ref", "Name", "Parent", "Project"));

QueryResponse subQueryResponse = null;
try {
    subQueryResponse = restApi.query(subFolderExistenceRequest);
} catch (Exception e) {
    logger.error("Error occurred while querying subfolder existence: " + e.getMessage(), e);
}

// Add a null check for subQueryResponse
if (subQueryResponse != null && subQueryResponse.wasSuccessful() && subQueryResponse.getTotalResultCount() > 0) {
    logger.info("Subfolder query was successful");
    // Folder exists as a subfolder
    lastFolder = subQueryResponse.getResults().get(0).getAsJsonObject();
    lastFolderRef = lastFolder.get("_ref").getAsString();
    logger.info("Subfolder already exists: " + lastFolderRef);
} else if (subQueryResponse == null) {
    logger.error("subQueryResponse is null. Failed to query subfolder existence.");
    break;
} else {
    // Folder does not exist, create it as a subfolder
    JsonObject newFolder = new JsonObject();
    newFolder.addProperty("Name", folderName.trim());
    newFolder.addProperty("Project", projectRef);
    newFolder.addProperty("Parent", lastFolderRef);

    CreateRequest createFolderRequest = new CreateRequest("testfolder", newFolder);
    CreateResponse createFolderResponse = restApi.create(createFolderRequest);

    if (createFolderResponse.wasSuccessful()) {
        lastFolderRef = createFolderResponse.getObject().get("_ref").getAsString();
        newFolder.addProperty("_ref", lastFolderRef);
        lastFolder = newFolder;
        logger.info("Successfully created subfolder: " + lastFolderRef);
    } else {
        logger.error("Error occurred creating subfolder");
        for (String error : createFolderResponse.getErrors()) {
            logger.error(error);
        }
        break;
    }
}
