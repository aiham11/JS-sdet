2024-08-21 19:17:43.148 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment URL: https://rally1.rallydev.com/slm/webservice/v2.0/attachment/800758921067
2024-08-21 19:17:43.148 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758921067
2024-08-21 19:17:43.148 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment added to Input field for Test Step 1: Attachments\TestStep_Attachments\1_1_EmbeddedFile_description.png
2024-08-21 19:17:43.880 [main] INFO  com.optum.coe.automation.rally.RallyOperation - AttachmentContentRef: https://rally1.rallydev.com/slm/webservice/v2.0/attachmentcontent/800758921079
2024-08-21 19:17:44.346 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment URL: https://rally1.rallydev.com/slm/webservice/v2.0/attachment/800758921081
2024-08-21 19:17:44.346 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758921081
2024-08-21 19:17:44.346 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment added to Input field for Test Step 1: Attachments\TestStep_Attachments\1_2_EmbeddedFile_description.png
2024-08-21 19:17:44.590 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758921093
2024-08-21 19:17:44.590 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Successfully created test step in Rally with OID: 800758921093 for TestCase: https://rally1.rallydev.com/slm/webservice/v2.0/testcase/800758896985
2024-08-21 19:17:45.178 [main] INFO  com.optum.coe.automation.rally.RallyOperation - AttachmentContentRef: https://rally1.rallydev.com/slm/webservice/v2.0/attachmentcontent/800758921133
2024-08-21 19:17:45.607 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment URL: https://rally1.rallydev.com/slm/webservice/v2.0/attachment/800758921135
2024-08-21 19:17:45.607 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758921135
2024-08-21 19:17:45.607 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment added to Input field for Test Step 4: Attachments\TestStep_Attachments\4_1_EmbeddedFile_description.png
2024-08-21 19:17:46.312 [main] INFO  com.optum.coe.automation.rally.RallyOperation - AttachmentContentRef: https://rally1.rallydev.com/slm/webservice/v2.0/attachmentcontent/800758921147
2024-08-21 19:17:46.722 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment URL: https://rally1.rallydev.com/slm/webservice/v2.0/attachment/800758921727
2024-08-21 19:17:46.723 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758921727
2024-08-21 19:17:46.723 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment added to Input field for Test Step 4: Attachments\TestStep_Attachments\4_2_EmbeddedFile_description.png
2024-08-21 19:17:46.944 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758921751
2024-08-21 19:17:46.944 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Successfully created test step in Rally with OID: 800758921751 for TestCase: https://rally1.rallydev.com/slm/webservice/v2.0/testcase/800758896985
2024-08-21 19:17:47.514 [main] INFO  com.optum.coe.automation.rally.RallyOperation - AttachmentContentRef: https://rally1.rallydev.com/slm/webservice/v2.0/attachmentcontent/800758922357
2024-08-21 19:17:47.930 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment URL: https://rally1.rallydev.com/slm/webservice/v2.0/attachment/800758922359
2024-08-21 19:17:47.930 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758922359
2024-08-21 19:17:47.930 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment added to Input field for Test Step 3: Attachments\TestStep_Attachments\3_1_EmbeddedFile_description.png
2024-08-21 19:17:48.578 [main] INFO  com.optum.coe.automation.rally.RallyOperation - AttachmentContentRef: https://rally1.rallydev.com/slm/webservice/v2.0/attachmentcontent/800758922371
2024-08-21 19:17:49.006 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment URL: https://rally1.rallydev.com/slm/webservice/v2.0/attachment/800758922383
2024-08-21 19:17:49.006 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758922383
2024-08-21 19:17:49.006 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment added to Input field for Test Step 3: Attachments\TestStep_Attachments\3_2_EmbeddedFile_description.png
2024-08-21 19:17:49.183 [main] ERROR com.optum.coe.automation.rally.RallyOperation - Failed to create test step in Rally: [Ljava.lang.String;@25ce435
2024-08-21 19:17:49.778 [main] INFO  com.optum.coe.automation.rally.RallyOperation - AttachmentContentRef: https://rally1.rallydev.com/slm/webservice/v2.0/attachmentcontent/800758922987
2024-08-21 19:17:50.209 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment URL: https://rally1.rallydev.com/slm/webservice/v2.0/attachment/800758923001
2024-08-21 19:17:50.210 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758923001
2024-08-21 19:17:50.210 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment added to Input field for Test Step 2: Attachments\TestStep_Attachments\2_1_EmbeddedFile_description.png
2024-08-21 19:17:51.018 [main] INFO  com.optum.coe.automation.rally.RallyOperation - AttachmentContentRef: https://rally1.rallydev.com/slm/webservice/v2.0/attachmentcontent/800758923193
2024-08-21 19:17:51.564 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment URL: https://rally1.rallydev.com/slm/webservice/v2.0/attachment/800758923197
2024-08-21 19:17:51.564 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Extracted OID: 800758923197
2024-08-21 19:17:51.564 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Attachment added to Input field for Test Step 2: Attachments\TestStep_Attachments\2_2_EmbeddedFile_description.png
2024-08-21 19:17:51.744 [main] ERROR com.optum.coe.automation.rally.RallyOperation - Failed to create test step in Rally: [Ljava.lang.String;@19ad75e5
2024-08-21 19:17:51.746 [main] INFO  com.optum.coe.automation.rally.Utils - The file Attachments\TestStep_Attachments\1_1_EmbeddedFile_description.png is deleted for the next attachment download run.
2024-08-21 19:17:51.750 [main] INFO  com.optum.coe.automation.rally.Utils - The file Attachments\TestStep_Attachments\1_2_EmbeddedFile_description.png is deleted for the next attachment download run.
2024-08-21 19:17:51.751 [main] INFO  com.optum.coe.automation.rally.Utils - The file Attachments\TestStep_Attachments\4_1_EmbeddedFile_description.png is deleted for the next attachment download run.
2024-08-21 19:17:51.752 [main] INFO  com.optum.coe.automation.rally.Utils - The file Attachments\TestStep_Attachments\4_2_EmbeddedFile_description.png is deleted for the next attachment download run.
2024-08-21 19:17:51.753 [main] INFO  com.optum.coe.automation.rally.Utils - The file Attachments\TestStep_Attachments\3_1_EmbeddedFile_description.png is deleted for the next attachment download run.
2024-08-21 19:17:51.753 [main] INFO  com.optum.coe.automation.rally.Utils - The file Attachments\TestStep_Attachments\3_2_EmbeddedFile_description.png is deleted for the next attachment download run.
2024-08-21 19:17:51.754 [main] INFO  com.optum.coe.automation.rally.Utils - The file Attachments\TestStep_Attachments\2_1_EmbeddedFile_description.png is deleted for the next attachment download run.
2024-08-21 19:17:51.754 [main] INFO  com.optum.coe.automation.rally.Utils - The file Attachments\TestStep_Attachments\2_2_EmbeddedFile_description.png is deleted for the next attachment download run.
2024-08-21 19:17:51.756 [main] INFO  com.optum.coe.automation.rally.RunnerClass - Processing CC2-T15
2024-08-21 19:17:51.867 [main] INFO  com.optum.coe.automation.rally.Utils - Successfully returned HttpEntity response for the URL https://jira.healthcareit.net/rest/atm/1.0/testcase/CC2-T15
2024-08-21 19:17:51.868 [main] INFO  com.optum.coe.automation.rally.JiraOperation - Testcase details for the keyCC2-T15: {"owner":"JIRAUSER97503","updatedBy":"JIRAUSER109514","customFields":{"Automation Status":"Not Automatable","Migrate Test to Rally":true},"keyNumber":15,"updatedOn":"2024-05-13T18:17:38.926Z","priority":"Normal","majorVersion":1,"createdOn":"2022-02-01T18:28:24.861Z","projectKey":"CC2","folder":"/ConnectCenter/Release 5.8.6/ConnectCenter - FY22 iteration 21/CC2-9027 QA - Regression on Eaas Service","latestVersion":true,"createdBy":"JIRAUSER97503","testScript":{"id":343402,"type":"STEP_BY_STEP","steps":[{"expectedResult":"The Claim should fire Error MEDNEC","index":0,"description":"Given a Institutional Claim with the setup needed to fire error MEDNEC is submitted via EMF Mailbox and this claim was ACCEPTED and processed by Exchange WHEN in EaaS it is configured to fire MEDNEC Errors and AND for CONNECT CENTER SETUP the Phase ID is Charge AND The Edit Packages enabled are all including CCI and MEDNEC for the submitter used (006274/000062)","id":3804155}]},"lastTestResultStatus":"Pass","name":"4)Gen Bill RaaS w_CCI_MN-Institutional-MEDNEC","parameters":{"variables":[],"entries":[]},"key":"CC2-T15","status":"Approved"}
2024-08-21 19:17:51.869 [main] INFO  com.optum.coe.automation.rally.RallyOperation - Rally values for the project key 789325818991 are assiged from rally_migration_config.properties file
2024-08-21 19:17:51.869 [main] VERBOSE com.optum.coe.automation.rally.RallyOperation - Below the values assigned from rally_migration_config.properties file. 




 public void migrateTestStepsWithAttachments(String rallyTestCaseOID, List<JiraTestStep> jiraTestSteps, RallyRestApi rallyApi, Map<Integer, List<String>> embeddedAttachmentsMap) {
        Set<String> processedAttachments = new HashSet<>();
        

        for (JiraTestStep jiraTestStep : jiraTestSteps) 
        
        
        
        { System.out.println("pringting the jira test steps on line 609 "+jiraTestStep  );
            try {
                JsonObject newTestStep = new JsonObject();
                newTestStep.addProperty("TestCase", rallyTestCaseOID);
                newTestStep.addProperty("StepIndex", jiraTestStep.getIndex() + 1);  // Adjust the index to start from 1
                
                // Combine "Step" and "Test Data" fields into the "Input" field in Rally
                String inputField = cleanText((jiraTestStep.getStep() != null ? jiraTestStep.getStep() : "") +
                                    (jiraTestStep.getTestData() != null ? "\n" + jiraTestStep.getTestData() : ""));
                newTestStep.addProperty("Input", inputField);
                
                // Map "Expected Result" field from Jira directly to Rally's "Expected Result" after cleaning the text
                String expectedResultField = cleanText(jiraTestStep.getExpectedResult());
                newTestStep.addProperty("ExpectedResult", expectedResultField);

                // Handle embedded attachments specific to this test step
                List<String> stepEmbeddedAttachments = embeddedAttachmentsMap.get(jiraTestStep.getIndex());
                if (stepEmbeddedAttachments != null && !stepEmbeddedAttachments.isEmpty()) {
                    for (String embeddedPath : stepEmbeddedAttachments) {
                        if (!processedAttachments.contains(embeddedPath)) {
                            // Extract the filename from the full path
                            String filename = embeddedPath.substring(embeddedPath.lastIndexOf("\\") + 1);
                            String[] attachmentParts = filename.split("_");

                            if (attachmentParts.length > 0) {
                                try {
                                    // Extract the step number from the first part of the filename
                                    int attachmentStepNumber = Integer.parseInt(attachmentParts[0]);

                                    // Check if this attachment corresponds to the current step
                                    if (attachmentStepNumber == jiraTestStep.getIndex() + 1) {  // Ensure the matching is correct
                                        String attachmentURL = attachFileToRallyTestCase(rallyApi, rallyTestCaseOID, embeddedPath);
                                        String attachmentOID = extractOID(attachmentURL);
                                        if (attachmentOID != null) {
                                        	
                                        	
                                        	
                                        	
                                        	
                                        	
                                            // Determine whether the attachment belongs to Input or ExpectedResult
                                            if (filename.contains("testData") || filename.contains("description")) {
                                                newTestStep.addProperty("Input", newTestStep.get("Input").getAsString() + " <img src='https://rally1.rallydev.com/slm/attachment/" + attachmentOID + "/content'/>");
                                                logger.info("Attachment added to Input field for Test Step " + (jiraTestStep.getIndex() + 1) + ": " + embeddedPath);
                                            } else if (filename.contains("expectedResult")) {
                                                newTestStep.addProperty("ExpectedResult", newTestStep.get("ExpectedResult").getAsString() + " <img src='https://rally1.rallydev.com/slm/attachment/" + attachmentOID + "/content'/>");
                                                logger.info("Attachment added to Expected Result field for Test Step " + (jiraTestStep.getIndex() + 1) + ": " + embeddedPath);
                                            } else {
                                                logger.warn("Attachment name does not contain a recognized field identifier (testData, description, expectedResult): " + embeddedPath);
                                            }
                                        }
                                        processedAttachments.add(embeddedPath);  // Mark this attachment as processed
                                    }
                                } catch (NumberFormatException e) {
                                    logger.error("Failed to parse step number from attachment name: " + filename, e);
                                }
                            }
                        }
                    }
                }

                CreateRequest createRequest = new CreateRequest("TestcaseStep", newTestStep);
                CreateResponse createResponse = rallyApi.create(createRequest);

                if (createResponse.wasSuccessful()) {
                    String testStepURL = createResponse.getObject().get("_ref").getAsString();
                    String testStepOID = extractOID(testStepURL);
                    logger.info("Successfully created test step in Rally with OID: " + testStepOID + " for TestCase: " + rallyTestCaseOID);
                } else {
                    logger.error("Failed to create test step in Rally: " + createResponse.getErrors());
                }
            } catch (IOException e) {
                logger.error("Exception occurred while creating test step in Rally", e);
            }
        }
    }





















