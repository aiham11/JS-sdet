public void migrateTestStepsWithAttachments(String rallyTestCaseOID, List<JiraTestStep> jiraTestSteps, RallyRestApi rallyApi, Map<Integer, List<String>> embeddedAttachmentsMap) {
    Set<String> processedAttachments = new HashSet<>();

    for (JiraTestStep jiraTestStep : jiraTestSteps) {
        System.out.println("Printing the jira test steps on line 609 " + jiraTestStep);
        try {
            JsonObject newTestStep = new JsonObject();
            newTestStep.addProperty("TestCase", rallyTestCaseOID);
            newTestStep.addProperty("StepIndex", jiraTestStep.getIndex() + 1);  // Adjust the index to start from 1

            // Combine "Step" and "Test Data" fields into the "Input" field in Rally
            StringBuilder inputFieldBuilder = new StringBuilder();
            String step = jiraTestStep.getStep() != null ? jiraTestStep.getStep() : "";
            String testData = jiraTestStep.getTestData() != null ? jiraTestStep.getTestData() : "";

            // Append step and test data to the input field
            if (!step.isEmpty()) {
                inputFieldBuilder.append(step).append("\n"); // Add step with a newline
            }
            if (!testData.isEmpty()) {
                inputFieldBuilder.append(testData).append("\n"); // Add test data with a newline
            }

            // Set the input field to the final value
            String inputField = inputFieldBuilder.toString();
            if (inputField.length() > 2048) {
                inputField = stripFormatting(inputField); // Strip formatting if it exceeds 2048 characters
            }
            newTestStep.addProperty("Input", inputField.trim()); // Trim any trailing newlines

            // Map "Expected Result" field from Jira directly to Rally's "Expected Result"
            String expectedResultField = cleanText(jiraTestStep.getExpectedResult());
            newTestStep.addProperty("ExpectedResult", expectedResultField); // Add expected result without formatting

            // Handle embedded attachments specific to this test step
            List<String> stepEmbeddedAttachments = embeddedAttachmentsMap.get(jiraTestStep.getIndex());
            if (stepEmbeddedAttachments != null && !stepEmbeddedAttachments.isEmpty()) {
                for (String embeddedPath : stepEmbeddedAttachments) {
                    if (!processedAttachments.contains(embeddedPath)) {
                        // Extract the filename from the full path
                        String filename = embeddedPath.substring(embeddedPath.lastIndexOf("\\") + 1);
                        String[] attachmentParts = filename.split("_");

                        if (attachmentParts.length > 0) {
                            try {
                                // Extract the step number from the first part of the filename
                                int attachmentStepNumber = Integer.parseInt(attachmentParts[0]);

                                // Check if this attachment corresponds to the current step
                                if (attachmentStepNumber == jiraTestStep.getIndex() + 1) {  // Ensure the matching is correct
                                    String attachmentURL = attachFileToRallyTestCase(rallyApi, rallyTestCaseOID, embeddedPath);
                                    String attachmentOID = extractOID(attachmentURL);
                                    if (attachmentOID != null) {
                                        // Determine whether the attachment belongs to Input or ExpectedResult
                                        if (filename.contains("testData") || filename.contains("description")) {
                                            String currentInput = newTestStep.get("Input").getAsString();
                                            newTestStep.addProperty("Input", currentInput + " <img src='https://rally1.rallydev.com/slm/attachment/" + attachmentOID + "/content'/>");
                                            logger.info("Attachment added to Input field for Test Step " + (jiraTestStep.getIndex() + 1) + ": " + embeddedPath);
                                        } else if (filename.contains("expectedResult")) {
                                            String currentExpectedResult = newTestStep.get("ExpectedResult").getAsString();
                                            newTestStep.addProperty("ExpectedResult", currentExpectedResult + " <img src='https://rally1.rallydev.com/slm/attachment/" + attachmentOID + "/content'/>");
                                            logger.info("Attachment added to Expected Result field for Test Step " + (jiraTestStep.getIndex() + 1) + ": " + embeddedPath);
                                        } else {
                                            logger.warn("Attachment name does not contain a recognized field identifier (testData, description, expectedResult): " + embeddedPath);
                                        }
                                    }
                                    processedAttachments.add(embeddedPath);  // Mark this attachment as processed
                                }
                            } catch (NumberFormatException e) {
                                logger.error("Failed to parse step number from attachment name: " + filename, e);
                            }
                        }
                    }
                }
            }

            CreateRequest createRequest = new CreateRequest("TestcaseStep", newTestStep);
            CreateResponse createResponse = rallyApi.create(createRequest);

            if (createResponse.wasSuccessful()) {
                String testStepURL = createResponse.getObject().get("_ref").getAsString();
                String testStepOID = extractOID(testStepURL);
                logger.info("Successfully created test step in Rally with OID: " + testStepOID + " for TestCase: " + rallyTestCaseOID);
            } else {
                String[] errors = createResponse.getErrors();
                logger.error("Failed to create test step in Rally: " + String.join(", ", errors));
            }
        } catch (IOException e) {
            logger.error("Exception occurred while creating test step in Rally", e);
        }
    }
}

// Helper method to strip formatting from text (removes HTML tags and styles)
private String stripFormatting(String input) {
    if (input == null) {
        return ""; // Return an empty string if input is null
    }
    // Remove any HTML tags
    return input.replaceAll("<[^>]*>", "").replaceAll("\\s+", " ").trim();
}
